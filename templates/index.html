<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Map App</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #000;
            color: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }






        .header {
            background-color: #ffffff;
            color: rgb(0, 0, 0);
            padding: 10px 0;
            text-align: center;
        }

        .main {
            display: flex;
            flex: 1;
            flex-direction: column;
            font-family: 'Roboto', sans-serif;
            margin: 100px 0 0 0;
            padding: 0;
            background-color: #f4f4f9;
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
        }

        @media(min-width: 768px) {
            .main {
                flex-direction: row;

            }
        }

        .sidebar {
            flex: 1 1 30%;
            padding: 20px;
            background: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            margin: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            color: #000;
        }

        .map-container {
            flex: 1 1 70%;
            position: relative;
            margin: 20px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .color-picker,
        .search-ticket {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .hidden {
            display: none;
        }

        label {
            font-weight: bold;
        }

        button,
        input[type="submit"] {
            background-color: #ee5566;
            color: white;
            border: none;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        button:hover,
        input[type="submit"]:hover {
            background-color: #cc4455;
        }

        input[type="file"],
        input[type="color"],
        input[type="text"] {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 80%;
        }

        .loader-container {
            display: none;
            justify-content: center;
            align-items: center;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 1000;
        }

        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #ee5566;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .blurred {
            filter: blur(5px);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .divider {
            width: 30%;
            height: 4px;
            background-color: #ee5566;
            margin: 70px 0;
        }
    </style>
</head>

<body>

    <div class="main">
        <div class="sidebar">
            <div class="header">
                <h1>Welcome to My CTDD Map</h1>
            </div>
            <div id="legend"
                style="position: absolute; bottom: 30px; left: 10px; background: white; padding: 10px; border-radius: 5px;">
                <h3>Legend</h3>
                <ul id="legend-list" style="list-style-type: none; padding-left: 0;"></ul>
            </div>

            <form id="upload-form" action="/process_csv" method="post" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="file">Upload your CSV file:</label>
                    <input type="file" id="file" name="file" accept=".csv" required>
                    <input type="submit" value="Upload">
                </div>
            </form>

            <div class="color-picker form-group">
                <label for="marker-color">Select Marker Color:</label>
                <input type="color" id="marker-color" name="marker-color" value="#0000FF">
                <button id="apply-color">Apply Color</button>
            </div>

            <div class="search-ticket form-group">
                <label for="ticket-search">Search by Ticket Number:</label>
                <input type="text" id="ticket-search" placeholder="Enter ticket number">
                <button id="search-ticket">Search</button>
            </div>
        </div>

        <div class="map-container" id="map-container">
            <div id="map"></div>
            <div class="loader-container" id="loader-container">
                <div class="loader"></div>
            </div>
        </div>
    </div>
    <div class="divider"></div>



    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiemVudHJhZGVzLW9uYm9hcmRpbmciLCJhIjoiY2x6dHdpbG9yMGdxejJtczV5eHZyajU5cSJ9.css9wXCRUwiSAm0tuCmM_Q';

        // Initialize the map
        var map = new mapboxgl.Map({
            container: 'map', // ID of the map container
            style: 'mapbox://styles/mapbox/streets-v11', // Map style
            center: [0, 0], // Initial map center [lng, lat]
            zoom: 2 // Initial zoom level
        });

        var markers = {};

        function createMarker(color, coordinates, popupContent) {
            var marker = new mapboxgl.Marker({
                color: color
            })
                .setLngLat(coordinates)
                .setPopup(new mapboxgl.Popup().setHTML(popupContent))
                .addTo(map);
            marker.getElement().addEventListener('click', function () {
                // Set the global selected marker
                window.selectedMarker = marker;
                // Update the color picker to match the current marker color
                document.getElementById('marker-color').value = color;
            });

            return marker;
        }

        document.getElementById('upload-form').onsubmit = function (event) {
            event.preventDefault();
            document.getElementById('loader-container').style.display = 'flex';
            document.getElementById('map').classList.add('blurred');

            var formData = new FormData(this);
            fetch('/process_csv', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loader-container').style.display = 'none';
                    document.getElementById('map').classList.remove('blurred');

                    // Clear existing markers
                    markers = {};

                    data.locations.forEach(item => {
                        var color = item.color;
                        var coordinates = [item.longitude, item.latitude];
                        var popupContent = `<b>Ticket Number:</b> ${item.ticket_number}<br><b>Customer:</b> ${item.customer}<br><b>Address:</b> ${item.address}<br><b>Description:</b> ${item.description}<br><b>Technician:</b> ${item.technician}`;

                        var marker = createMarker(color, coordinates, popupContent);

                        markers[item.ticket_number] = marker;
                    });

                    // Update the legend
                    var legendList = document.getElementById('legend-list');
                    legendList.innerHTML = ''; // Clear previous legend
                    Object.keys(data.job_type_colors).forEach(jobType => {
                        var color = data.job_type_colors[jobType];
                        var legendItem = document.createElement('li');
                        legendItem.innerHTML = `<span style="background-color: ${color}; width: 15px; height: 15px; display: inline-block; margin-right: 5px;"></span>${jobType}`;
                        legendList.appendChild(legendItem);
                    });

                    if (data.locations.length > 0) {
                        map.fitBounds(data.locations.map(item => [item.longitude, item.latitude]), { padding: 20 });
                    }
                })
                .catch(error => {
                    document.getElementById('loader-container').style.display = 'none';
                    document.getElementById('map').classList.remove('blurred');
                    console.error('Error:', error);
                });
        };


        document.getElementById('apply-color').onclick = function () {
            if (!window.selectedMarker) {
                alert('Please select a marker first by clicking on it.');
                return;
            }

            var color = document.getElementById('marker-color').value;

            // Update the marker color by directly modifying the SVG fill attribute
            var markerElement = window.selectedMarker.getElement();
            var svg = markerElement.querySelector('svg');
            if (svg) {
                var path = svg.querySelector('path');
                if (path) {
                    path.setAttribute('fill', color);
                }
            }
        };

        document.getElementById('search-ticket').onclick = function () {
            var searchValue = document.getElementById('ticket-search').value;
            if (searchValue === '') {
                Object.values(markers).forEach(marker => marker.getElement().style.display = 'block');
            } else {
                Object.keys(markers).forEach(ticketNumber => {
                    if (ticketNumber === searchValue) {
                        markers[ticketNumber].getElement().style.display = 'block';
                        markers[ticketNumber].togglePopup();
                    } else {
                        markers[ticketNumber].getElement().style.display = 'none';
                    }
                });
            }
        };
    </script>
</body>

</html>